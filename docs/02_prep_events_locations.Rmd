---
title: "02 Prep Events Locations"
author: "Rex W. Douglass and Kristen Harkness"
date: "12/9/2017"
output: 
  html_notebook:
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: inline
---

Cleans and converts location information in the event dataset and saves as a spatial R object for analysis.

# Loads

```{r, results='hide', message=FALSE, warning=FALSE }
rm(list=ls()); gc()
library(MeasuringLandscapeCivilWar)
devtools::load_all()

knitr::opts_knit$set(progress = TRUE, verbose = TRUE)
knitr::opts_chunk$set(fig.width=12, fig.height=8,  warning=FALSE, message=FALSE, cache=TRUE)
options(width = 160)


events <- readRDS(system.file("extdata", "MeasuringLandscapeCivilWar_events_cleaned.Rdata", package = "MeasuringLandscapeCivilWar"))
dim(events)

```

# Clean Map Coordinates (East Africa Grid System)

```{r }

cat("\014")

#Cases to handle
#"928141"
#"311449  328445    338443"
#"EASTING 30 and 27"
#"EastLeigh Sect.7"
#"FARM 535/4"
#"HAC  0202"
#"HAC.577236"
#"HZN 974641 & HZN 974651"
#"HZJ. 8595"
#"HZJ. 465765, HZJ. 459771, HZJ. 451756"
#"HZJ 42765, HZJ 42375and HZJ 429761"
#"HZH 960610, HZH 960630, HZH 977538"
#"H.Z.R. 4786"
#"HAD 1708, HAD 1709"
#"HAD 3326/3327"
#"HZJ 42765, HZJ 42375and HZJ 429761"
#"HZJ 9518  9617"
#"HZP 7430, HZP 9029, HZP 6448, HZP 7252, HZP 9448"

events$map_coordinate %>% tabyl() 

events$map_coordinate_clean <- events$map_coordinate %>% str_replace_all("[[:punct:]]| ", "") 
(events$map_coordinate_clean_length <- events$map_coordinate_clean %>% nchar() ) %>% tabyl() %>% round(3)

(events$map_coordinate_clean_text <- events$map_coordinate_clean %>% gsub("[0-9]", "\\1",.)) %>% tabyl()  %>% mutate_if(is.numeric, round,2) #Split into a text component and numeric component
(events$map_coordinate_clean_number <- events$map_coordinate_clean %>% gsub("[A-Za-z]", "\\1", .) ) %>% tabyl()  %>% mutate_if(is.numeric, round,2)

(events$map_coordinate_clean_text_band <- events$map_coordinate_clean_text %>% substring(1,1) ) %>% tabyl()  %>% mutate_if(is.numeric, round,2)
(events$map_coordinate_clean_text_block <- events$map_coordinate_clean_text %>% substring(2,2) ) %>% tabyl()  %>% mutate_if(is.numeric, round,2)
(events$map_coordinate_clean_text_subblock <-  events$map_coordinate_clean_text %>%  substring(3,3) ) %>% tabyl()  %>% mutate_if(is.numeric, round,2)

(events$map_coordinate_clean_number_length <- events$map_coordinate_clean_number %>% nchar() ) %>% tabyl()  %>% mutate_if(is.numeric, round,2)
(events$map_coordinate_clean_number_easting <- events$map_coordinate_clean_number %>%
                                              substring(1, events$map_coordinate_clean_number_length/2) %>% as.numeric() ) %>%
                                              tabyl()  %>% mutate_if(is.numeric, round,2)

(events$map_coordinate_clean_number_northing <- events$map_coordinate_clean_number %>%
                                              substring(events$map_coordinate_clean_number_length/2+1, events$map_coordinate_clean_number_length) %>%
                                              as.numeric() )  %>%
                                              tabyl()  %>% mutate_if(is.numeric, round,2)

```

## Convert Coordinates to lat long

```{r ,results=FALSE, warning=FALSE, comment=FALSE}

#This takes

cat("\014")
print("Starting Converting Coordinates, may take some time")
for(i in 1:nrow(events)){
  # print(i)
  suppressMessages({
    temp <- events[i,] %$% EAGS2LatLong(band=map_coordinate_clean_text_band,
                                        block=map_coordinate_clean_text_block,
                                        subblock=map_coordinate_clean_text_subblock,
                                        easting=map_coordinate_clean_number_easting , 
                                        northing=map_coordinate_clean_number_northing)
    events$map_coordinate_clean_latitude[i] <- temp$latitude
    events$map_coordinate_clean_longitude[i] <- temp$longitude
  })
  #print(is.na(events$map_coordinate_clean_latitude[i]))
}
print("Finished Converting Coordinates")

```

```{r}

#(temp <- events %>% mutate(map_coordinate_clean_row=1:n()) %>% filter(is.na(map_coordinate_clean_latitude) & !is.na(map_coordinate_clean)) %>% select(starts_with("map_coordinate_clean")) ) %>% distinct() %>% print(n=40) #visualize errors
#dim(temp) #195 coordinates don't convert.

testing=F
if(testing){
  i=3684
  events[i,] %>%  select(starts_with("map_coordinate_clean")) %$% EAGS2LatLong(band=map_coordinate_clean_text_band,
                                                                              block=map_coordinate_clean_text_block,
                                                                              subblock=map_coordinate_clean_text_subblock,
                                                                              easting=map_coordinate_clean_number_easting , 
                                                                              northing=map_coordinate_clean_number_northing)
  
  with(events[i,], map_coordinate_clean)
  with(events[i,], map_coordinate)
  band <- with(events[i,], map_coordinate_clean_text_band)
  block <- with(events[i,],map_coordinate_clean_text_block)
  subblock <- with(events[i,],map_coordinate_clean_text_subblock) #
  easting <- with(events[i,],map_coordinate_clean_number_easting)
  northing <- with(events[i,],map_coordinate_clean_number_northing)
}

stats::quantile(events$map_coordinate_clean_latitude, probs =c(.005,.01,.1,.5,.9,.99,.995), na.rm=T, type=9) 
stats::quantile(events$map_coordinate_clean_longitude, probs =c(.005,.01,.1,.5,.9,.99,.995), na.rm=T, type=9)
plot(events$map_coordinate_clean_longitude,events$map_coordinate_clean_latitude)

#This is just to remove absolutely clear outliers. Not to set the region of interest.
#Outlier Bounding Box:
#NE 4.62933, 41.899059
#SW -4.71712, 33.90884
events$map_coordinate_clean_latitude[events$map_coordinate_clean_latitude < -4.71712 |
                                      events$map_coordinate_clean_latitude>4.62933] <- NA
events$map_coordinate_clean_longitude[events$map_coordinate_clean_longitude < 33.90884 |
                                      events$map_coordinate_clean_longitude>41.899059] <- NA
plot(events$map_coordinate_clean_longitude,events$map_coordinate_clean_latitude)

```

    

# District of Document

-Likewise, the plots suggest some district cleaning still necessary. Jock Scott was an operation in Nairobi and all of those can be changed to Nairobi. Central Province and Rift Valley Province are not districts. Not sure if that matters at this stage... but we probably want to reassign the points we can geolocate from them to an actual district.

Districts: 
-Jock Scott, rift valley, and central province aren't districts. I think Jock Scott is a small town within a district, not sure which one. Central province and rift valley are provinces, one administrative unit higher than the district.
-the districts should be: Baringo, Elgeyo/Marakwet, Embu, Fort Hall, Kajiado, Kiambu, Kitui, Laikipia, Machakos, Meru, Naivasha, Nakuru, Nanyuki, Narok, Nyeri, Thika, and then Nairobi City
-we retrieved events from both district level and provincial level files and we should make sure that that didn't create duplicate events
-Here is my list of our coverage from the files we looked at (the star means we have complete files for the emergency): 

*Baringo
    Mar 51-Aug 61
*Elgeyo/Marakwet
    Mar 53-Aug 61
*Embu
    Nov 51-Aug 61    
Fort Hall
    Nov 51-Aug 54 (possibly missing end)
*Kajiado
    Aug 53-Aug 61
*Kiambu
    Nov 51-Aug 61
Kitui
    Dec 51-Feb 53 (possibly missing end)
*Laikipia
    Nov 51-Dec 57 (Jan 58-Aug 60 in provincial files)
Machakos
    Mar 53-Dec 55
*Meru
    Dec 51-Aug 61
*Naivasha
    May 53-Dec 57; Jan 58-Aug 60 in provincial files
*Nakuru
    Mar 53-Dec 53; Oct 54-Dec 57; Jan 58-Aug 60 in provincial files
*Nanyuki
    Dec 51-Sep 53; Jan 54-Dec 54; Dec 55-Aug 61
*Narok
    May 51-Feb 53; Aug 53-Aug 61
*Nyeri
    Nov 51-Aug 61
*Thika
    Dec 51-Aug 61

Nairobi City
    Mar 53-Dec 56

Central Province
    Mar 53-Jan 57

Rift Valley Province
    Feb 51- Dec 53; Jan 58-Aug 60

```{r , results="asis"}

cat("\014")

#clean document district
p_load(car,stringi,xtable)

events$document_district_clean <- str_trim(stri_trans_totitle(events$document_district))

events$document_district_clean <- events$document_district_clean %>% recode(" 
                                   'Embu-Fort Hall Border'='Embu';
                                  'BARINGO'='Baringo';
                                   'FORT HALL'='Fort Hall'; 
                                   'Naviasha'='Naivasha';
                                   'Nyeri Settled Area'='Nyeri';
                                  'South Nyeri Reserve'='Nyeri' ;
                                   'Reference Serial'=NA ;
                                  'H/M'=NA; 'Matathia'=NA;  
                                   'Kitui'=NA; 
                                  'Jock Scott'='Nairobi';
                                   ''=NA; 
                                   ' '=NA ;
                                   'Document District' = NA")


events$document_unit_type <- NA
condition <- events$document_district_clean %in% c("Rift Valley","Central Province"); table(condition)
events$document_unit_type[condition] <- "Province"

#Jock Scott Nairobi City
condition <- events$document_district_clean %in% c("Nairobi"); table(condition)
events$document_unit_type[condition] <- "City"

condition <- events$document_district %in% c("JOCK SCOTT"); table(condition)
events$document_unit_type[condition] <- "Operation Jock Scott"


#Missing? Elgeyo/Marakwet
#Baringo, , Embu, Fort Hall, Kajiado, Kiambu, Kitui, Laikipia, Machakos, Meru, Naivasha, Nakuru, Nanyuki, Narok, Nyeri, Thika
condition <- events$document_district_clean %in% c("Baringo","Embu","Fort Hall","Kajiado","Kiambu",
                                                 "Laikipia","Machakos","Meru","Naivasha","Nakuru",
                                                  "Nanyuki","Narok","Nyeri","Thika"); table(condition)
events$document_unit_type[condition] <- "District"
table(events$document_unit_type, useNA="always")

districts <- data.frame(sort( table(events$document_district_clean))); names(districts) <- "Count"
kable(districts)

```

# Handle suffixes and directions

```{r, cache=T }

#Now we need to handle suffixes and combined locations
#"farm" now is followed by things because they crunched in additional location info at the end
#"coles estate farm
# agriculture experimental farm
#demonstration farm
#"farm near churo"
#reubens farm near churo
################################################
#
events$location_text_ruleclean <- events$location_text %>% str_trim() %>% tolower()
events <- events %>% 
         dplyr::select(-one_of("location_text_ruleclean_connector_prefix","location_text_ruleclean_connector_suffix")) %>%  
          separate(col=location_text_ruleclean,
                    into=c("location_text_ruleclean_connector_prefix","location_text_ruleclean_connector_suffix"),
                    sep = " of | near ", remove=F, extra="drop", fill="right")

```


# Rule based hand cleaning

This section applies lots of rule based hand cleaning to the original text labels

```{r, cache=F ,echo=F, eval=F, results=FALSE, warning=FALSE, comment=FALSE}

#Rule list
rulelist <- list(

#Different versions
c("lady eleanor cole farm at elmentetia","cole farm"),
c("t.falls","thomson's falls"),
c("thomson's falls","thomsons falls"),
c("t\\/falls","thomsons falls"),
c("s\\.n\\.r\\.|s\\.n\\.r|s n r","south nyeri reserve"),
c("ft\\.hall|f\\.hall$|f\\.h\\.|f\\.h$| fh | f\\.hall"," fort hall "),
c("^aberdarea$|^aberdares fort hall$|^abordareon$|^aberdares$","aberdares range"),
c("^aberdar$|nyeri\\(aberdares\\)|^aberdare$","aberdare forest reserve"),
c("saw mills|saw mill| mill$| mills$","sawmills"),
c("^city$|^city district$","nairobi"),
c("east-leigh|eastleigh section|eastleigh section 7","eastleigh"),
c("currys|curry","curry's farm"),
c("^booth$","booth's farm"),
c("^botha$","botha's farm"),
c("^brown and borwick$","brown and borwick's farm"),
c("^de bruin$","de bruin's farm"),
c("^de wat$|^de wet$","dewetts farm"),
c("^deigton$|^deighton downs$","deighton down's farm"),
c("$carnelly^","carnelly's farm"),
c("^case$","case's farm"),
c("^daniels$|^danials$|^daniel$","Daniel's farm"),
c("^dawberry$","dawberry's farm"),
c("^king$","king's farm"), #Make sure this isn't getting kinghorn
c("^andersen$|^andersens$","'s farm"),
c("^howard williams$","howard williams's farm"),
c("^brown's dairy$","brown's farm"),
c("^sandford's dairy$","sandford's farm"),
c("^augerad$","'augerad's farm"),
c("^baker$","baker's farm"),
c("^becker$","becker's farm"),
c("^blain$","blain's farm"),
c("^lariak$","lariak's farm"),
c("^marmanet$|^marmenet$","marmanet forest reserve"),
c("^kagaari","kagaare location"),
c(" fram$"," farm"),
c("^kariokor|^kariokor house|^kariokor police post","nairobi"),
c("mbari ya kihara","kiambu settled farms"),
c("thegenge","thigingi location"),
c("kithiruni|kitherune","kithirune sublocation"),
c("upper abothoguchi","upper abothuguchi location"),
c("river edge"," river "),


#Round 2 rules
c("kiandai","kiangai"),
c("kianyagga","kianyaga"),
#c("township","thika (ppl not the whole district)"),
#c("van rensberry and randall","[split into two different farms, both on farms list]"),
c("entoltol","entontol"),
c("dundori|dundori area|dundori nakuru","dondori area"),
c("eastleigh 7","eastleigh"),
c("eburru|eburru area","opuru area"),
c("for t hall|f\\.hall|for t hall|forthall","fort hall"),
c("gachuku","konyu location"), #[doc says gachuku within this location, can’t find better]
c("gaki aguthi","aguthi location"), #[within this location; can’t find gaki]
c("gatugura|gataguru|gatuguru|gguraatu","gatagura"), #[which is a village (ppl) according to docs but not in gaz]"),
c("gekondi","gikondi"), #[both a location and a sublocation, docs don’t say which applies]"),
c("gikandu|gikandi|gikindu","gekandu"),
#c("grimbeck and mcintyre","[split into two different farms, both on farms list]"),
#c("horn [kinghorn getting cleaned to horn, should stay kinghorn which is on the farm list]"),
c("wanyagga","wanyaga sublocation"),
c("wangige", "Chura division"), #"[in Chura division; can’t tell from docs what it is; gazateer has a marketplace with the same name]"),
c("s. kinangop","south kinangop’ "),
c("south githunguri","south gathangari location"),
c("school lane|nairobi city|kariakor|brewery|city park|secretariat|secretariat new|capitol|nairobi dam|municipal landhies","nairobi"),
c("suswa railway station|suswa station landhies","suswa station"), #(rstn in gazateer)
c("rotaian, rotain","rotian area"), #[mispelled, doc says its an area; in the gazateer as an area]"
c("leea fara","lees farm"),
#c("makindi swamp [in gazateer under swamps (swmp)]"),

c("mariira|marira","mareira"),
c("mbogoti|mbogiti","mbugiti"),
c("menangai crater|near menengai crater","meneng’ai crater"), #(crtr in gazateer)
c("miles fletcher","fletcher"),
c("miriga meyru|miriga mieru|miiriga mieru","nyaki location"),
c("murarandia|murirandia|muriri-andia|muririanda","murarandia"), # [there are two ppl in the gazateer, called murarandia 1 and murarandia 2, which are 0deg 2min apart E and identical S… we have so many map codes probably best to use those instead of choosing from the gazateer]
c("murengetti","murengeti"),
c("n.tetu","north tetu"),
c("n.nyeri","north nyeri"),
c("nairagie ngare|nairagengare|nairagie ngarie|nairagenengare|nairage ngare|nairage ngare area","nairagiengare"),
c("^ndaragu$", "ndaragu location"),
c("^ngobi$|^ngobit$","ongobit"), #[gazateer says see ongobit, a ppl, but all you get is a police station; it’s a town of some kind though as docs mention a shop being broken into]
c("riakanya|riakania|riakanyau","riakiania"), #[docs confirm its a village]
c("a.aggett","aggett farm"),
c("^adakaini$", "adakaini village"),
c("agatha", "aguthi location"),
c(" fn", " farm"),
c("at elmentetia|elmentetia|elmentetita", "elmenteita area"),
c("emba","embu division"),  #[all three instances come from one document that specifically refers to embu division within embu district]
#c("boma = like a family’s group of huts; can probably drop from place names"),
c("estate ngobit","sirrima estate ngobit [coders dropped the name of the estate on both instances]"),
c("erega","muthambe location"), #= referred to as an area in 
c("ezaigeri","esaigeri bore hole"), #(direct from document; no match in gazateer but would fall under wells)
c("fausto's camp","chief fausto’s camp"),
c("gacharege|kacharage","gacharage"),
c("gakurwa|gakuruwe","gakurwe"),
c("gatandu","gatundu sublocation"), #[spelled right in docs]
c("^gatari$|^gatiri$","gaturi location"), #[spelled right in docs]
c("^gatisi$","gatisi village"), #(ppl but no match in gazateer; have map code)
c("^gatugi$","gatugi"), #(two matches in gazateer, gatugi one and gatugi two; have map code)
#c("giakanja ?div, giakanja s/div","giakanja= in thegenge location in south nyeri reserve (best I can do, all the docs are tables)"),
c("giljil|in gilgil|upper gilgil","gilgil"),
c("githumi|githunu","githumu"),
c("githimi","githima"),
c("githerere area|githwere","githerere"),
c("^gitoba$", "gitoba ppl"),
c("hakurwe|gukurwa","gakurwe sublocation"),
c("kaganduini|kagenduini|kaguinduini","kagunduini sublocation"), #[coder mispelling]
c("kahuhai|kahuhia plot","kahuhia"),
c("kalou","ol kalou"),
c("kagunoini|kagumioni guard post","kagumoini"),
c("kambambi$","kambandi village"),
c("kamuiri|kamuru","kamuiru"),
c("^kandara boma$|^kandar$","kandara"),
c("^kanjeria$", "kanjeria"), #in gatundu division in kiambu district [from collective punishment data]
c("kanyamini","kanyariri"),
c("kanyenyeni|kanyanyeni|kanganyieini","kanyenyeini sublocation"),
c("karugoya","kerugoya"), #[spelled right in docs]
c("karunandi|karunonui","karumandi"),
c("kathenjure|kathunjure|kathenjuri|kathanguiu","kathungure"),
c("kedong","nkidongi"),
c("kedong valley","nkidongi valley"), #(val in gazateer)
c("kerugoya|ketugoya","keruguya sublocation"), #ppl or 
c("kiamaringa","kiamariga sublocation"),
c("kiamatugu|kianatugu|kianatuga|kiamotugu","kiamutugu"),
c("kiandai area","kiangai area"), #[informal area in the vicinity of kiangai, a ppl]
c("kianburu","kiambururu sublocation"),
c("kianjeggr|kianjegge mky.","kianjegge"),
c("^kianyagarer$","kianyaga"), #[really blurry doc and coders tacked the first 3 letters of the map code, which should be HZR, onto the place name; so map codes screwed up on these obs as well]
c("kiari|kiaria","kiairia"),
c("kiarutugu","kiamutugu"),
c("kibercha$|kiberichia$|kiberiohia$","kibirichia location"),
c("kiburi|kiburu soh.","kiburu"),
c("^kigari$","kigari mission"), #(mssn in gazateer) [docs refer to it as a mission as well]
c("^kiharo$","kiharo division"), # in fort hall district
c("kihome mahiga$","kihome sublocation"), #(ppl or sub-location) in mahiga location
c("kihomi konyu$","kihomi konyu sublocation"), #[probably the same as kihome sub-location but not sure]"
#c("kiine and mwerua = two different places, have both already just need to split up"),
c("kijabe area","kijabe"), #[they mean in the vicinity of]
c("kijegge$","kijegge forest"), #(frst in gazateer)
c("ol bolossat$","ol bolossat forest reserve"),
c("ol lalunga","olololong’a"),
c("$olkalou$","ol kalou area"), #= area [not official administrative but informal]
c("olombokeshi","olombokishi area"),
c("oljoro orok","ol joro orok"),
c("olosho ol choro","olosho olchoro area"),
c("olorophil","oloropil area"),
c("orengitok","eorengitok area"),
c("s. gaturi","south gaturi location"),
c("^south lake$|^south lake naivasha$|^south lake area$","south lake naivasha area"),
c("^south mwerua$", "south mwerua location"),
c("^south ngariama$","south ngariama location"),
c("^south nyeri$","south nyeri reserve"),
c("riitho","ritho"),
c("rireni","rironi"),
c("runyenges|ruyenges","runyenjes"),
c("north githunguri","north gathangari location"),
c("north kinagop|north kinangop area","north kinangop"),
c("chart farm labour","chart farm"),
c("sow mill","saw mill"),
c("snr|s\\.n\\.r\\.|s\\.n\\.r"," south nyeri reserve"),
c("reubens farm churo","reubens farm"),
c("gatumbiro","gatumbire"),
c("karuri tc","karuri"),
c("kiarie land","kiarie"),
c("kiburu soh\\.","kiburu"),
c("barkerfarm","barker farm"),


#Farms with multiple names
c("^allan davies land$|^allan davies$","allan davies farm"),
c("^angeraud$|^angerau$|^augeraud$|^augerand$","augerand farm"),
c("^brown and browick$|^brown & borwick$","brown & borwick farm"),
c("^garles$|^carles$","carles farm"),
c("^clarke’s fm$|^clarke$|^clarke’s farm$","clarke’s farm"),
c("^van dam$|^coles estate$","coles estate"),
c("^colviler's$|^colvile’s$","colvile’s farm"),
c("^davis$|^davies$","davies farm"),
c("^deighton$|^deighton downs$","deighton downs farm"),
c("^etherington's$|^etherington$","etherington farm"),
c("^fowler's labour line$|^fowler's$","fowler's farm"),
c("^goodhinde's squatter$|^goodhinde's$","goodhinde's farm"),
c("^griffins$|^griffin's$|^griffin$","griffin farm"),
c("^hewitts fara$|^hewett's$","hewett's farm"),
c("^hiokman's$|^hickman$","hickman farm"),
c("^r.long$|^long$","long farm"),
c("^lues$|^luies$","luies farm"),
c("^vanera$|^manera$","manera farm"),
c("^mullers$|^muller$","muller farm"),
c("^oberholtzer$|^oberholzer$","oberholzer farm"),
c("^ol.pojeta$|^ol pejeta$","ol pejeta farm"),
c("^pllard$|^pollard$","pollard farm"),
c("^r.hok's$|^r.hook's$","r.hook's farm"),
c("^randall$|^randalls farm$","randalls farm"),
c("^s.k.bastard$|^s.e.bastard$","s.e.bastard farm"),
c("batard","bastard"),
c("bastardfarm","bastard farm"),
c("^squairs farm$|^squairs$|^squair$","squair farm"),
c("^trent$|^trents$","trents farm"),
c("^f.van blerk$|^w.van blerk$|^van bl rk$|^van blerk$","van blerk farm"),
c("^w.f. van dyk$|^van dyk$","van dyk farm"),
c("^riverside estate$|^van rensberg$","van rensberg farm"),
c("^feys$|^ven fey$","ven fey farm"),
c("^farm of mr.ward$|^ward$","ward farm"),
c("^vilson$|^wilson$","wilson farm"),

c("^shah & patel$|^shah &patel's sawmills$","shah & patel's sawmills"),
c("^geita sawmills$|^geita sawmill$","geita sawmill"),
c("^mawingo$|^mawingo hotel$","mawingo hotel"),
c("^tremaine$","tremaine hotel"),

c("^mariashone timber co\\.$|^mariashone$|^mariashone timber company$","mariashone mill"),
c("^karuri tc$","karuri mill"),

c("1sawmills|timbersawmills","sawmill"),

c("bushsawmills","bush sawmills"),
c("sowsawmills","sow sawmills"),
c("mariashonesawmills","mariashone sawmills"),
c("fernandefarm","fernande farm"),
c("\\.fort hall"," fort hall"),

#city suffixes
c(", powy",""),
c(" in gilgil",""),
c(", gamble",""),
c(" nyeri",""),
c("\\.ngobit",""),
c("-gitika",""),
c(", nairobi",""),
c("embu$",""),

c("coles estate","cole estate"),
c("govt rd","government road"),


#Abbreviations
c("rv\\.| rv$"," river "),
c(" rd$"," road"),
c(" rd$| rd\\.$"," road"),
c("loc.(\\?=\\S)|loc\\. |loc |loc\\.| loc$| loc.$|^loc | loc "," location "),
c("(?=.+)location"," location"),
c("^mt\\.","mount "),
c("mt\\.","mount "),
c(" est\\.?$"," estate"),
c("^mr\\.|^mr ","mr. "),
c("^mrs\\.|^mrs ","mrs. "),
c(" hg | h.g.| h.g"," home guard "),
c(" frm| fm\\.| fram$"," farm "),
c("rivr","river"),
c("inter.school","school"),
c("hll","hill"),
c("s/loc","sub-location"),
c("forest\\.","forest"),
c("s/div","sub-division"),
c("location\\)","location"),
c("hills","hill"),
c("dept","deptartment"),
c("sawmills","sawmill"),
#c("ol ol ol","ol"),
c("\\'$",""),
c("mkt","Market"),
c("\\(location","location"),
c(" st$| st\\. "," street "),
c("sub location","sub-location"),
c("brig.barkufarm","brig barkufarm"),

#Spelling
c("eatate|entate","estate"),
c("01","ol"),
c("- ","-"),
c(" estata| entate| eatate"," estate"),
c("\\\"s","\\'s"),
c("\\&"," and "),
c("\\' s"," "),
c("\\' "," "),
c("\\'s farm"," farm"),
c("ol ol"," ol "),

#Directions
c("s\\.w\\."," south west "),
c("s\\.e\\."," south east "),
c("n\\.w\\."," north west "),
c("n\\.e\\."," north east "),
#c("^w\\.","west "),
#c("^e\\.","east "),
#c("^s\\.","south "),
#c("^n\\.","north "),
c(" n of."," north of")

)

events$location_text_ruleclean <- events$location_text %>% gsub("\\s+"," ", . ) %>% str_trim() %>% tolower()
for(q in rulelist){
  events$location_text_ruleclean <- gsub(q[1],q[2],events$location_text_ruleclean, perl=T, ignore.case = T)
  print(paste("Rule: ",q[1],"->",q[2]))
}

#Farms
farms <- c("aggett", "akira ranch", "allan davies", "augerand", "borman", "bornmann", "brahmer", "brown & borwick", "camm’s", "carles", "carr hartley", "cedar mount dairy", "christopher",  "clarke’s farm", "coles estate", "collinson", "colvile’s", "colville", "corbett", "cowan", "daubeny", "davies" , "deighton downs", "delap", "dickinson", "edwards", "elliot", "elliott",  "etherington", "eyre matcham", "fenn hall",  "findlays", "fletcher", "fletcher", "forrester", "fourie", "fowler's", "fritzgerald", "g.murray", "gillett", "goddard", "goodhinde's", "gotha", "greyling", "griffin", "griffiths", "grimbeck", "grimwood's", "hall", "hallowes", "harcourt's", "hart", "harvey", "hawkins", "hesselbergers", "hewett's", "hickman", "hoffman", "hoffmeyer", "hogg", "holyoak's", "homberg", "howard-willams", "hurndall", "icely", "j.gillett", "jennings", "joubert", "kelsall", "kerrison", "kinghorn", "laikipia ranching co.", "laing", "lambie", "lennox", "leshau", "lesirko", "long", "luies", "mac connell", "mac lellan", "macmillans", "maloney's", "manera", "marula", "mcconnell", "mcgill", "mclellan", "meiklejohn", "meyler", "miller", "mr. lansburg of thomsons falls", "muller", "oberholzer", "odendaal", "ol magogo", "ol pejeta", "osbourne's", "page", "partridge", "paton ker", "payne williams", "petersen", "pieters", "pilbrow", "plaat", "platter", "podo park", "pollard", "r.hook's", "randalls farm", "rensburg", "retief", "reynard", "ridley shaw", "robertsons", "roger hurt", "s.e.bastard", "s.smith", "sandford's", "schofield", "sharpe", "shaw", "sipili", "skinner", "slades", "slains", "spooner", "squair", "strongs", "subugu", "swift", "thynne's", "tomlinson", "trents", "trichardt", "truran", "tryon", "tucker", "van blerk", "van der westhuizen", "van deventer", "van dyk", "van landsbergh", "van landsburg", "van rensberg", "van straaten", "vaughan", "ven fey", "von landsberg", "wace", "wainewright", "ward", "wellmont", "wilson")

for(q in farms){
  regex <- paste0("^",q,"$")
  events$location_text_ruleclean <- gsub(regex,paste(q, " farm"),events$location_text_ruleclean, perl=T, ignore.case = T)
  print(paste(q))
}

events$location_text_ruleclean  <- events$location_text_ruleclean %>% 
                                   gsub("sublocation","sub-location",. ) %>%
                                   gsub("- ","-",.)  %>%
                                   gsub("farms"," farm",.) %>% 
                                   gsub("s farm"," farm",.)

```

```{r}

events <- events %>% mutate(name_clean=str_trim(tolower(location_text))) %>%
           mutate(name_clean_posessive=grepl("'s|`s",name_clean)) %>%
           mutate(name_cleaner=trimws(name_clean)  ) %>%
           mutate(name_cleaner=gsub("'s|`s","",name_cleaner, fixed=T)  ) %>%
           mutate(name_cleaner= str_replace_all(name_cleaner, "[[:punct:]]|`", "")  ) %>% 
           mutate(name_cleaner= str_replace_all(name_cleaner, "[^[:alnum:] ]", "")  ) %>%  #removes all the weird unicode and ascii
           mutate(name_cleaner=trimws(name_cleaner)  ) %>%
           mutate(name_cleaner_nospace= str_replace_all(name_cleaner, " ", "") )

table(unlist(strsplit(events$name_cleaner,"")))

```




# Create a Simple Features Version GIS Version

It is based on an events dataset built and cleaned in another file.

```{r}

events_sf <- events %>% # filter(!is.na(longitude) & !is.na(latitude))  %>%
  distinct() %>%
  # filter( between(longitude, 30.0,45.0)  )  %>%  #Flag ROI but don't subset on it yet
  # filter( between(latitude, -5.0,5.0) ) %>%
  mutate(name_clean = str_trim(tolower(location_text))) %>%
  mutate(name_clean_posessive = grepl("'s|`s", name_clean)) %>%
  mutate(name_cleaner = trimws(name_clean)) %>%
  mutate(name_cleaner = gsub("'s|`s", "", name_cleaner, fixed = T)) %>%
  mutate(name_cleaner = str_replace_all(name_cleaner, "[[:punct:]]|`", "")) %>%
  mutate(name_cleaner = trimws(name_cleaner)) %>%
  mutate(name_cleaner_nospace = str_replace_all(name_cleaner, " ", ""))

# Avoid creating geometries where one of the two is NA
events_sf$map_coordinate_clean_longitude[is.na(events_sf$map_coordinate_clean_latitude)] <- NA
events_sf$map_coordinate_clean_latitude[is.na(events_sf$map_coordinate_clean_longitude)] <- NA
events_sf$event_hash <- NULL #Make sure we're not hashing on the previous hash which might be a random walk

events_sf <- events_sf %>%
            st_as_sf(coords = c("map_coordinate_clean_longitude", "map_coordinate_clean_latitude"),
                     crs = 4326, agr = "constant", remove = F, na.fail = F)  %>% 
             mutate(event_hash = apply(., 1, digest, algo="xxhash64") ) #Do this once and only once
valid <- st_is_valid(events_sf$geometry); table(valid)

eventsnames_sf <- events_sf %>% select("name_cleaner", "geometry") %>% setNames(c("name", "geometry")) %>% mutate(source_dataset = "events")




```

# Output Cleaned Files

```{r}

saveRDS(events, glue(getwd(), "/../inst/extdata/MeasuringLandscapeCivilWar_events_cleaned.Rdata"))

saveRDS(events_sf, glue(getwd(), "/../inst/extdata/events_sf.Rdata"))

```
